
<header class="main-header">
    <div class="welcome-section">
        <h1>Collection History</h1>
        <p>Review past performance</p>
    </div>
</header>

<section class="history-page">
    <div class="tab-navigation">
        <button class="tab-btn active" data-period="today">Today</button>
        <button class="tab-btn" data-period="week">This Week</button>
        <button class="tab-btn" data-period="month">Monthly stats</button>
    </div>

    <div class="today-collections-section">
        <div class="section-header">
            <h2 id="collections-title">Today's Collections</h2>
        </div>

        <div class="collection-list" id="collection-list">
            <div class="no-collections"><p>No collection yet</p></div>
        </div>
    </div>

    <div class="performance-summary-section">
        <h2>Performance Summary</h2>
        <div class="metric-item">
            <span class="metric-label">Collection Rate</span>
            <div class="progress-bar-container">
                <div class="progress-bar green-progress" id="collection-rate-bar" style="width: 60%;"></div>
            </div>
            <span class="metric-value" id="collection-rate-value">60%</span>
        </div>

        <div class="metric-item">
            <span class="metric-label">Efficiency</span>
            <div class="progress-bar-container">
                <div class="progress-bar green-progress" id="efficiency-bar" style="width: 75%;"></div>
            </div>
            <span class="metric-value" id="efficiency-value">75%</span>
        </div>
        
        <div class="metric-item">
            <span class="metric-label">Total Collections</span>
            <span class="metric-value" id="total-collections">85</span>
        </div>
        
        <div class="metric-item">
            <span class="metric-label">Total Weight</span>
            <span class="metric-value" id="total-weight">1250.5 kg</span>
        </div>
    </div>
</section>

<script>
// Default performance data
const DEFAULT_PERFORMANCE = {
    collection_rate: 60,
    efficiency: 75,
    total_collections: 85,
    total_weight: 1250.5
};

document.addEventListener('DOMContentLoaded', function() {
    let currentPeriod = 'today';
    
    // Load initial data
    loadHistory(currentPeriod);
    
    // Tab navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Load data for selected period
            currentPeriod = this.getAttribute('data-period');
            loadHistory(currentPeriod);
        });
    });
});

function loadHistory(period) {
    fetch(`/api/driver/history/?period=${period}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        updateCollectionsList(data.collections || [], period);
        // Use performance data from API or defaults
        const performance = data.performance || DEFAULT_PERFORMANCE;
        updatePerformanceMetrics(performance);
    })
    .catch(error => {
        console.error('Error loading history:', error);
        const list = document.getElementById('collection-list');
        if (list) {
            list.innerHTML = '<div class="no-collections"><p>No collection yet</p></div>';
        }
        // Use default performance data on error
        updatePerformanceMetrics(DEFAULT_PERFORMANCE);
    });
}

function updateCollectionsList(collections, period) {
    const list = document.getElementById('collection-list');
    const title = document.getElementById('collections-title');
    
    // Update title based on period
    const titles = {
        'today': "Today's Collections",
        'week': "This Week's Collections",
        'month': "This Month's Collections"
    };
    if (title) {
        title.textContent = titles[period] || "Collections";
    }
    
    if (!list) return;
    
    if (collections.length === 0) {
        list.innerHTML = '<div class="no-collections"><p>No collection yet</p></div>';
        return;
    }
    
    list.innerHTML = collections.map(collection => {
        // Determine quality based on fill level
        let quality = 'good';
        let qualityText = 'Good';
        if (collection.fill_level >= 90) {
            quality = 'good';
            qualityText = 'Excellent';
        } else if (collection.fill_level >= 50) {
            quality = 'average';
            qualityText = 'Good';
        } else {
            quality = 'low';
            qualityText = 'Fair';
        }
        
        return `
            <div class="collection-item">
                <div class="item-main">
                    <div class="status-dot completed-dot"></div>
                    <span class="location">${collection.location}</span>
                    <span class="details type">Collection</span>
                    <span class="details time">${collection.time}</span>
                </div>
                <div class="item-stats">
                    <span class="stat-value">${collection.estimated_weight} kg</span>
                    <span class="stat-value quality ${quality}">${qualityText}</span>
                </div>
            </div>
        `;
    }).join('');
}

function updatePerformanceMetrics(performance) {
    // Use defaults if performance is missing
    if (!performance) {
        performance = DEFAULT_PERFORMANCE;
    }
    
    // Update collection rate
    const rateBar = document.getElementById('collection-rate-bar');
    const rateValue = document.getElementById('collection-rate-value');
    if (rateBar && rateValue) {
        const rate = performance.collection_rate || DEFAULT_PERFORMANCE.collection_rate;
        rateBar.style.width = rate + '%';
        rateValue.textContent = rate + '%';
    }
    
    // Update efficiency
    const efficiencyBar = document.getElementById('efficiency-bar');
    const efficiencyValue = document.getElementById('efficiency-value');
    if (efficiencyBar && efficiencyValue) {
        const efficiency = performance.efficiency || DEFAULT_PERFORMANCE.efficiency;
        efficiencyBar.style.width = efficiency + '%';
        efficiencyValue.textContent = efficiency + '%';
    }
    
    // Update total collections
    const totalCollections = document.getElementById('total-collections');
    if (totalCollections) {
        const total = performance.total_collections || DEFAULT_PERFORMANCE.total_collections;
        totalCollections.textContent = total;
    }
    
    // Update total weight
    const totalWeight = document.getElementById('total-weight');
    if (totalWeight) {
        const weight = performance.total_weight || DEFAULT_PERFORMANCE.total_weight;
        totalWeight.textContent = weight + ' kg';
    }
}
</script>
