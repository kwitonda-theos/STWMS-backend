<div class="content-header">
    <div class="header-text">
        <h2>Add New Location</h2>
        <p class="subtitle">Create a new location for waste bins</p>
    </div>
</div>
<button class="btn btn-outline" onclick="loadBinForm()" style="margin-bottom: 20px;">
    <i class="fas fa-arrow-left"></i> Back to Create Tank
</button>

<div style="background: white; border-radius: 12px; padding: 30px; border: 1px solid #747373; max-width: 600px; margin: 20px 0;">
    {% if form %}
    <form method="post" id="location-create-form" action="{% url 'stwms:location_create' %}">
        {% csrf_token %}
        
        {% for field in form %}
        <div style="margin-bottom: 20px;">
            <label for="{{ field.id_for_label }}" style="display: block; font-size: 16px; font-weight: 500; margin-bottom: 6px; color: #070707;">
                {{ field.label }}{% if field.field.required %} <span style="color: #dc3545;">*</span>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}
            <small style="display: block; margin-top: 4px; color: #666; font-size: 12px;">{{ field.help_text }}</small>
            {% endif %}
            {% if field.errors %}
            <div style="color: #dc3545; font-size: 12px; margin-top: 4px;">
                {{ field.errors|join:", " }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        
        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button class="btn-outline" type="submit" style="flex: 1; border-radius: 8px;">
                <i class="fas fa-save"></i> Create Location
            </button>
            <button class="btn-outline" type="button" onclick="loadBinForm()" style="flex: 1; background: #f5f5f5; color: #333; border: 1px solid #747373; border-radius: 8px;">
                Cancel
            </button>
        </div>
    </form>
    {% else %}
    <p>Error loading form. Please try again.</p>
    {% endif %}
</div>

<style>
    #location-create-form input,
    #location-create-form select,
    #location-create-form textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background-color: #fafafa;
        color: #1a1a1a;
        box-sizing: border-box;
    }
    
    #location-create-form input:focus,
    #location-create-form select:focus,
    #location-create-form textarea:focus {
        outline: none;
        border-color: #006325;
        background-color: #fff;
    }
</style>

<script>
// Make loadBinForm available globally
window.loadBinForm = function() {
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
        return fetch('/bins/create/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load content');
                }
                return response.text();
            })
            .then(html => {
                mainContent.innerHTML = html;
                
                // Execute any scripts in the loaded HTML (same as loadContent does)
                const scripts = mainContent.querySelectorAll('script');
                scripts.forEach(function(oldScript) {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => {
                        newScript.setAttribute(attr.name, attr.value);
                    });
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });
                
                return Promise.resolve();
            })
            .catch(error => {
                console.error('Error loading bin form:', error);
                return Promise.reject(error);
            });
    }
    return Promise.resolve();
};

// Handle form submission via AJAX
(function() {
    const form = document.getElementById('location-create-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    return response.json();
                }
                return response.text();
            })
            .then(data => {
                if (typeof data === 'object' && data.success) {
                    // Success - reload bin form and update location field
                    window.loadBinForm();
                    // After bin form loads, update the location select if it exists
                    setTimeout(() => {
                        const locationSelect = document.querySelector('#id_location');
                        if (locationSelect && data.location_id) {
                            // Add the new location option if it doesn't exist
                            let optionExists = false;
                            for (let option of locationSelect.options) {
                                if (option.value === data.location_id) {
                                    optionExists = true;
                                    break;
                                }
                            }
                            if (!optionExists) {
                                const newOption = new Option(data.location_display, data.location_id, false, true);
                                locationSelect.add(newOption);
                            } else {
                                locationSelect.value = data.location_id;
                            }
                            // Trigger change event to notify any listeners
                            locationSelect.dispatchEvent(new Event('change'));
                        }
                    }, 300);
                } else if (typeof data === 'string') {
                    // Form errors - replace content with updated form
                    const mainContent = document.querySelector('.main-content');
                    if (mainContent) {
                        mainContent.innerHTML = data;
                    }
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                alert('An error occurred. Please try again.');
            });
        });
    }
})();
</script>

